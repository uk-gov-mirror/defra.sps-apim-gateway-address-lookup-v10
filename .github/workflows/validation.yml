name: Validate APIM Structure

on:
  pull_request:
    branches:
      - master
      - develop

jobs:
  validate-apim-structure:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run APIM Validation check
        shell: pwsh
        run: |
          $RootPath = "${{ github.workspace }}"
          $ApiName = "sample-api"  # Replace with dynamic detection if needed
          $ParentFolders = @("external", "internal")
          $Environments = @("base")

          # Execute external script
          .\scripts\Validate-APIMStructure.ps1 -RootPath $RootPath -ParentFolders $ParentFolders -Environments $Environments -ApiName $ApiName

           $custom = "### üîé APIM Validation ‚Äî `${{ github.repository }}`  `n* PR: #${{ github.event.pull_request.number }} ‚Äî ${{ github.event.pull_request.title }}`n* Commit: ${{ github.sha }}`n* Result: " + ($(if($code -eq 0){'‚úîÔ∏è Passed'} else {'‚ùå Failed'}))
              $custom | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

              "exit_code=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
              exit 0

      - name: Fail job if validation failed
        if: steps.validate.outputs.exit_code != '0'
        shell: pwsh
        run: |
          $code = '${{ steps.validate.outputs.exit_code }}'
          Write-Output "::error::APIM validation failed with exit code $code"
          exit 1

