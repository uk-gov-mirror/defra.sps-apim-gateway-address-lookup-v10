name: Validate APIM Structure

on:
  pull_request:
    branches:
      - master
      - develop

jobs:
  validate-apim-structure:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run APIM Validation check
        id: validate                    # <-- REQUIRED to read outputs later
        shell: pwsh
        run: |
          $root = "${{ github.workspace }}"
          $parents = @('external','internal')
          $envs = @('base')

          # run the script
          pwsh -File .\scripts\Validate-APIMStructure.ps1 `
            -RootPath $root `
            -ParentFolders $parents `
            -Environments $envs
          $code = $LASTEXITCODE         # <-- CAPTURE the exit code

          # write summary
          $custom = @"
          ### ðŸ”Ž APIM Validation â€” `${{ github.repository }}`
          * PR: #${{ github.event.pull_request.number }} â€” ${{ github.event.pull_request.title }}
          * Commit: `${{ github.sha }}`
          * Result: $(if($code -eq 0){'âœ”ï¸ Passed'} else {'âŒ Failed'})
          "@
              $custom | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

              # expose the code as a step output
              "exit_code=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

              # DO NOT fail here; let the next step decide
              exit 0
      - name: Fail job if validation failed
        if: steps.validate.outputs.exit_code != '0'
        shell: pwsh
        run: |
          $code = '${{ steps.validate.outputs.exit_code }}'
          Write-Output "::error::APIM validation failed with exit code $code"
          exit 1
