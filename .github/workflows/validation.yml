name: Validate APIM Structure

on:
  pull_request:
    branches:
      - master
      - develop

jobs:
  validate-apim-structure:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run APIM Validation check
        id: validate
        shell: pwsh
        run: |
          $root = "${{ github.workspace }}"
          $parents = @('external','internal')
          $envs = @('base')

          pwsh -File .\scripts\Validate-APIMStructure.ps1 `
            -RootPath $root `
            -ParentFolders $parents `
            -Environments $envs
          $code = $LASTEXITCODE

          $custom = @"
          ### üîé APIM Validation ‚Äî `${{ github.repository }}`
          * PR: #${{ github.event.pull_request.number }} ‚Äî ${{ github.event.pull_request.title }}
          * Commit: `${{ github.sha }}`
          * Result: $(if($code -eq 0){'‚úîÔ∏è Passed'} else {'‚ùå Failed'})
          "@
          $custom | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

          "exit_code=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          exit 0

      - name: Fail job if validation failed
        if: steps.validate.outputs.exit_code != '0'
        shell: pwsh
        run: |
          $code = '${{ steps.validate.outputs.exit_code }}'
          Write-Output "::error::APIM validation failed with exit code $code"
          exit 1

      # ‚úÖ Carbon Metrics Calculation with GPU
      - name: Calculate Carbon Metrics (SCI Formula)
        id: carbon
        shell: pwsh
        run: |
          # CPU time
          $CPUTimeSec = (Get-Process | Measure-Object CPU -Sum).Sum
          # RAM usage
          $RAMMB = (Get-CimInstance Win32_OperatingSystem).TotalVisibleMemorySize / 1024
          # GPU info
          $GPUName = (Get-CimInstance Win32_VideoController).Name
          $GPUStatus = (Get-CimInstance Win32_VideoController).Status

          # Energy and emissions
          $EnergyKWh = [math]::Round(($CPUTimeSec * 0.0000003) + ($RAMMB * 0.0000001), 6)
          $CarbonIntensity = 475
          $Emissions = [math]::Round($EnergyKWh * $CarbonIntensity, 2)

          # Build report
          $report = @"
          ## üå± Carbon Metrics Report
          * Energy Consumed: $EnergyKWh kWh
          * Estimated CO‚ÇÇ Emissions: $Emissions g
          * CPU Time: $CPUTimeSec sec
          * RAM Usage: $RAMMB MB
          * GPU: $GPUName ($GPUStatus)
          "@

          # Save report to output
          "report<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          $report | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Post Carbon Metrics to PR
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.carbon.outputs.report }}
